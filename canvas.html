<html>
<head>
    <title></title>
    <script type="text/javascript">

        var context;
        var palette;
        var buffer;
        var coolingMap;
        var width;
        var height;
        var scale = 4;

        function init()
        {
             initPalette();

             element = document.getElementById('canvas');
             width = element.width;
             height = element.height;

             buffer = Array(width * height / scale);
             coolingMap = Array(width * height / scale);

             initCoolingMap();

             context = element.getContext("2d");
             context.fillRect(0, 0, width, height);

             update();
        }

        function initPalette()
        {
            palette = Array(256);

            for(i = 0; i < 64; i++)
            {
                palette[i] = rgbToColor((i << 2), 0, 0);
                palette[i + 64] = rgbToColor(255, (i << 2), 0);
                palette[i + 128] = rgbToColor(255, 255, (i << 2));
                palette[i + 192] = rgbToColor(255, 255, 255);
            }
        }

        function initCoolingMap()
        {
            for(x = 0; x < width / scale; x++)
            {
                for(y = 0; y < height; y++)
                {
                    coolingMap[(width * y + x) / scale] = randomValue(6);
                }
            }

            var values = Array(4);

            for(x = 0; x < width / scale; x++)
            {
                for(y = 0; y < height; y++)
                {
                    values[0] = coolingMap[pointToIndex(x, y - 1)];
                    values[1] = coolingMap[pointToIndex(x - 1, y)];
                    values[2] = coolingMap[pointToIndex(x + 1, y)];
                    values[3] = coolingMap[pointToIndex(x, y + 1)];

                    coolingMap[pointToIndex(x, y)] = average(values);
                }
            }
        }

        function pointToIndex(x, y)
        {
            return (width * y + x) / scale;  
        }

        function rgbToColor(r, g, b)
        {
            return (r << 16 | g << 8 | b);          
        }

        function colorToString(color)
        {
            return "#" + ("00000" + (color).toString(16)).slice(-6);
        }

        function update()
        {
            for(x = 0; x < width / scale; x++)
            {
                drawPixel(x, height / scale, palette[randomValue(palette.length)]);
                drawPixel(x, height / scale - 1, palette[randomValue(palette.length)]);
            }

            smooth();

            requestAnimFrame(function(){
                update();
            });
        }

        function smooth()
        {
            var pixels = Array(8);

            for(x = 2; x < width / scale - 2; x++)
            {
                for(y = 0; y < height / scale; y++)
                {
                    pixels[0] = getPixel(x - 1, y - 1);
                    pixels[1] = getPixel(x, y - 1);
                    pixels[2] = getPixel(x + 1, y - 1);
                    pixels[3] = getPixel(x - 1, y);
                    pixels[4] = getPixel(x + 1, y);
                    pixels[5] = getPixel(x - 1, y + 1);
                    pixels[6] = getPixel(x, y + 1);
                    pixels[7] = getPixel(x + 1, y + 1);

                    pixel = average(pixels);

                    pixel = sub(pixel, coolingMap[pointToIndex(x, y)]);
                    
                    drawPixel(x, y - 1, pixel);
                }
            }
        }

        function average(pixels)
        {
            var rt = 0;
            var gt = 0;
            var bt = 0;

            for(i = 0; i < pixels.length; i++)
            {
                var pixel = pixels[i];
                
                var r = (pixel >> 16);
                var g = (pixel >> 8) & 0xff;    
                var b = (pixel) & 0xff;

                rt += r;
                gt += g;
                bt += b;
            }

            return rgbToColor(
                rt / pixels.length,
                gt / pixels.length,
                bt / pixels.length);
        }

        function sub(pixel, value)
        {
            var r = (pixel >> 16);
            var g = (pixel >> 8) & 0xff;    
            var b = (pixel) & 0xff;

            r = Math.max(0, r - value);
            g = Math.max(0, g - value);
            b = Math.max(0, b - value);

            return rgbToColor(r, g, b);
        }

        function drawPixel(x, y, color)
        {
            var index = width * y + x;   
            buffer[index / scale] = color;        

            context.fillStyle = colorToString(color);
            context.fillRect(x * scale, y * scale, scale, scale);
        }

        function getPixel(x, y)
        {
            var index = width * y + x;           
            value = buffer[index / scale];
            return (value == null) ? 0 : value;
        }

        function randomValue(max)
        {
            return Math.round(Math.random() * (max - 1));
        }

        window.onload = function(){
            init();
        };

        window.requestAnimFrame = (function(callback){
            return window.requestAnimationFrame ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame ||
            window.oRequestAnimationFrame ||
            window.msRequestAnimationFrame ||
            function(callback){
                window.setTimeout(callback, 1000 / 60);
            };
        })();
 
    </script>
</head>
<body>
<canvas id="canvas" width="320" height="200"></canvas>
</body>
</html>