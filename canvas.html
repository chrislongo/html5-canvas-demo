<html>
<head>
    <title></title>
    <script type="text/javascript">

        var context;
        var palette;
        var colorMap;
        var coolingMap;
        var width;
        var height;
        var scale = 2;

        function init()
        {
             initPalette();

             element = document.getElementById('canvas');
             width = element.width;
             height = element.height;

             colorMap = Array(width * height / scale);
             coolingMap = Array(width * height / scale);

             for(var i = 0; i < colorMap.length; i++)
                colorMap[i] = 0;

             initCoolingMap();

             context = element.getContext("2d");
             context.fillRect(0, 0, width, height);

             update();
        }

        function initPalette()
        {
            palette = Array(256);

            for(i = 0; i < 64; i++)
            {
                palette[i] = rgbToColor((i << 2), 0, 0);
                palette[i + 64] = rgbToColor(255, (i << 2), 0);
                palette[i + 128] = rgbToColor(255, 255, (i << 2));
                palette[i + 192] = rgbToColor(255, 255, 255);
            }
        }

        function initCoolingMap()
        {
            for(x = 0; x < width / scale; x++)
            {
                for(y = 0; y < height; y++)
                {
                    coolingMap[(width * y + x) / scale] = randomValue(5);
                }
            }

            var values = Array(4);

            for(x = 0; x < width / scale; x++)
            {
                for(y = 0; y < height; y++)
                {
                    values[0] = coolingMap[toIndex(x, y - 1)];
                    values[1] = coolingMap[toIndex(x - 1, y)];
                    values[2] = coolingMap[toIndex(x + 1, y)];
                    values[3] = coolingMap[toIndex(x, y + 1)];

                    coolingMap[toIndex(x, y)] = average(values);
                }
            }
        }

        function toIndex(x, y)
        {
            return Math.floor((width * y + x) / scale);  
        }

        function rgbToColor(r, g, b)
        {
            return (r << 16 | g << 8 | b);          
        }

        function colorToString(color)
        {
            return "#" + ("00000" + (color).toString(16)).slice(-6);
        }

        function update()
        {
            for(x = 0; x < width / scale; x++)
            {
                colorMap[toIndex(x, height / scale)] = randomValue(palette.length);
                colorMap[toIndex(x, height / scale - 1)] = randomValue(palette.length);
            }

            smooth();
            draw();

            requestAnimFrame(function(){
                update();
            });
        }

        function smooth()
        {
            for(var x = 1; x < width / scale - 1; x++)
            {
                for(var y = 0; y < height / scale; y++)
                {
                    var p = (
                        colorMap[toIndex(x - 1, y - 1)] + 
                        colorMap[toIndex(x, y - 1)] + 
                        colorMap[toIndex(x + 1, y - 1)] + 
                        colorMap[toIndex(x - 1, y)] + 
                        colorMap[toIndex(x + 1, y)] + 
                        colorMap[toIndex(x - 1, y + 1)] + 
                        colorMap[toIndex(x, y + 1)] + 
                        colorMap[toIndex(x + 1, y + 1)]) / 8;

                    p = Math.floor(p);

                    p -= coolingMap[toIndex(x, y)];
                    if(p < 0) p = 0;

                    colorMap[toIndex(x, y - 1)] = p;
                }
            }
        }

        function draw()
        {
            for(var x = 0; x < width / scale; x++)
            {
                for(var y = 0; y < (height / scale) - 2; y++)
                {
                    var index = toIndex(x, y);
                    var value = colorMap[index];
                    
                    if(value == null) 
                        value = 0;
                    
                    if(colorMap[index] != 0)
                        drawPixel(x, y, palette[value]);        
                }
            }       
        }

        function average(pixels)
        {
            var rt = 0;
            var gt = 0;
            var bt = 0;

            for(i = 0; i < pixels.length; i++)
            {
                var pixel = pixels[i];
                
                var r = (pixel >> 16);
                var g = (pixel >> 8) & 0xff;    
                var b = (pixel) & 0xff;

                rt += r;
                gt += g;
                bt += b;
            }

            return rgbToColor(
                rt / pixels.length,
                gt / pixels.length,
                bt / pixels.length);
        }

        function drawPixel(x, y, color)
        {
            context.fillStyle = colorToString(color);
            context.fillRect(x * scale, y * scale, scale, scale);
        }

        function randomValue(max)
        {
            return Math.round(Math.random() * (max - 1));
        }

        window.onload = function(){
            init();
        };

        window.requestAnimFrame = (function(callback){
            return window.requestAnimationFrame ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame ||
            window.oRequestAnimationFrame ||
            window.msRequestAnimationFrame ||
            function(callback){
                window.setTimeout(callback, 1000 / 60);
            };
        })();
 
    </script>
</head>
<body>
<canvas id="canvas" width="320" height="200"></canvas>
</body>
</html>